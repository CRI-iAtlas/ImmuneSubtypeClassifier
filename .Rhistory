early_stopping_rounds = 4,
gamma = 0.2,
lambda = 1.8,
alpha = 0.2,
ensemble_size = 11,
sample_prop = 0.8,
feature_prop = 0.8,
subsample = 0.8
)
stratified_pair_list <- readRDS('../models/pair_list_stratified.rds')
idx <- which(stratified_pair_list == 'STAT1_1')
stratified_pair_list[idx] <- 'STAT1'
this_set <- stratified_pair_list #[1:64]
new_list <- editPairList(this_set, 'IGJ')
99*2
# Now use the cleaned pair_list
result <- build_robencla_classifier(
data_path='../data/formatted_full_L1000/EBpp_pancancer_matched.csv.gz',
test_path='../data/formatted_full_L1000/xena_rsem_tpm.csv.gz',
output_path = '../models/immune_optimized_99_pairs.rds',
pair_list = new_list,
sig_list = NULL,
param_list = conservative_params,
data_mode = c("namedpairs"),
train_fraction = 1.0,
seed = 412,
sample_id = "Barcode"  # Specify the sample ID column
)
# Now use the cleaned pair_list
result <- build_robencla_classifier(
data_path='../data/formatted_full_L1000/training/EBpp_pancancer_matched.csv.gz',
test_path='../data/formatted_full_L1000/training/xena_rsem_tpm.csv.gz',
output_path = '../models/immune_optimized_99_pairs.rds',
pair_list = new_list,
sig_list = NULL,
param_list = conservative_params,
data_mode = c("namedpairs"),
train_fraction = 1.0,
seed = 412,
sample_id = "Barcode"  # Specify the sample ID column
)
# Now use the cleaned pair_list
result <- build_robencla_classifier(
data_path='../data/formatted_full_L1000/training/EBpp_pancancer_cleaned.csv.gz',
test_path='../data/formatted_full_L1000/training/xena_rsem_tpm_cleaned.csv.gz',
output_path = '../models/immune_optimized_99_pairs.rds',
pair_list = new_list,
sig_list = NULL,
param_list = conservative_params,
data_mode = c("namedpairs"),
train_fraction = 1.0,
seed = 412,
sample_id = "Barcode"  # Specify the sample ID column
)
ebpp_clean <- fread('../data/formatted_full_L1000/training/EBpp_pancancer_cleaned.csv.gz')
ebpp_clean$SampleID
hist(ebpp_clean$E2F2)
hist(ebpp_clean$RALA)
hist(ebpp_clean$EGF)
hist(log2(ebpp_clean$EGF+0.001))
ebpp_matched <- fread('../data/formatted_full_L1000/EBpp_pancancer_matched.csv.gz')
ebpp_matched <- fread('../data/formatted_full_L1000/training/EBpp_pancancer_matched.csv.gz')
ebpp_clean <- fread('../data/formatted_full_L1000/EBpp_pancancer.csv.gz')
xena_clean <- fread('../data/formatted_full_L1000/xena_rsem_tpm.csv.gz')
cat("Loaded cleaned datasets:\n")
cat("EBPP:", nrow(ebpp_clean), "x", ncol(ebpp_clean), "\n")
cat("Xena:", nrow(xena_clean), "x", ncol(xena_clean), "\n\n")
ebpp_orig <- fread('../data/formatted_full_L1000/EBpp_pancancer.csv.gz')
xena_orig <- fread('../data/formatted_full_L1000/xena_rsem_tpm.csv.gz')
cat("Loaded cleaned datasets:\n")
cat("EBPP:", nrow(ebpp_orig), "x", ncol(ebpp_orig), "\n")
cat("Xena:", nrow(xena_orig), "x", ncol(xena_orig), "\n\n")
shared_genes <- intersect(colnames(xena_orig), colnames(ebpp_orig))
shared_genes <- setdiff(shared_genes, c("Barcode", "Label", "SampleID", "sample"))
cat("Shared genes:", length(shared_genes), "\n\n")
shared_genes <- intersect(colnames(xena_orig), colnames(ebpp_orig))
"Barcodes" %in% shared_genes
"Barcode" %in% shared_genes
"Label" %in% shared_genes
ebpp_clean <- ebpp_orig[, shared_genes]
xena_clean <- xena_orig[, shared_genes]
ebpp_clean <- ebpp_orig[, ..shared_genes]
xena_clean <- xena_orig[, ..shared_genes]
# Verify columns match
if (!all(colnames(ebpp_clean) == colnames(xena_clean))) {
stop("Column names don't match between EBPP and Xena!")
}
cat("=== Transforming EBPP to match Xena pipeline ===\n")
# Identify metadata columns (these will NOT be transformed)
metadata_cols <- c("SampleID", "Barcode", "Label", "label")
existing_metadata <- intersect(colnames(ebpp_clean), metadata_cols)
cat("Metadata columns (will be preserved):", paste(existing_metadata, collapse=", "), "\n")
# Gene columns are everything else
gene_cols <- setdiff(colnames(ebpp_clean), metadata_cols)
cat("Gene columns to transform:", length(gene_cols), "\n\n")
# Check current data ranges
cat("Before transformation:\n")
ebpp_sample_genes <- sample(gene_cols, min(5, length(gene_cols)))
cat("EBPP sample genes:\n")
for (g in ebpp_sample_genes) {
cat(sprintf("  %s: [%.2f, %.2f]\n", g,
min(ebpp_clean[[g]], na.rm=TRUE),
max(ebpp_clean[[g]], na.rm=TRUE)))
}
xena_sample_genes <- sample(gene_cols, min(5, length(gene_cols)))
cat("\nXena sample genes:\n")
for (g in xena_sample_genes) {
cat(sprintf("  %s: [%.2f, %.2f]\n", g,
min(xena_clean[[g]], na.rm=TRUE),
max(xena_clean[[g]], na.rm=TRUE)))
}
Done in matching code
#Done in matching code
# Log-transform EBPP gene columns ONLY
# Xena pipeline: log2(TPM + 0.001)
cat("\nApplying log2(TPM + 0.001) transformation to EBPP...\n")
for (gene in gene_cols) {
ebpp_clean[[gene]] <- log2(ebpp_clean[[gene]] + 0.001)
}
cat("\nAfter log2(x + 0.001) transformation:\n")
cat("EBPP sample genes:\n")
for (g in ebpp_sample_genes) {
cat(sprintf("  %s: [%.2f, %.2f]\n", g,
min(ebpp_clean[[g]], na.rm=TRUE),
max(ebpp_clean[[g]], na.rm=TRUE)))
}
log2(0+0.001)
# Verify metadata columns were NOT transformed
cat("\nMetadata verification:\n")
for (mc in existing_metadata) {
if (mc == "Label") {
cat(sprintf("  %s: %s (preserved)\n", mc,
paste(head(unique(ebpp_clean[[mc]]), 3), collapse=", ")))
} else if (mc %in% c("SampleID", "Barcode")) {
cat(sprintf("  %s: %s... (preserved)\n", mc,
paste(head(ebpp_clean[[mc]], 2), collapse=", ")))
}
}
cat("\nâœ“ EBPP transformed to log2 scale, metadata preserved\n\n")
set.seed(412)
# Shuffle Xena
xena_shuffled <- xena_clean[sample(nrow(xena_clean)), ]
# Split 50/50
xena_train_size <- floor(0.5 * nrow(xena_shuffled))
xena_train <- xena_shuffled[1:xena_train_size, ]
xena_test <- xena_shuffled[(xena_train_size + 1):nrow(xena_shuffled), ]
cat("=== Stratified Split ===\n")
cat("EBPP (all for training, log-transformed):", nrow(ebpp_clean), "\n")
cat("Xena training (50%):", nrow(xena_train), "\n")
cat("Xena test holdout (50%):", nrow(xena_test), "\n\n")
# Verify metadata in splits
cat("Metadata columns in all datasets:\n")
cat("  EBPP:", paste(intersect(colnames(ebpp_clean), metadata_cols), collapse=", "), "\n")
cat("  Xena train:", paste(intersect(colnames(xena_train), metadata_cols), collapse=", "), "\n")
cat("  Xena test:", paste(intersect(colnames(xena_test), metadata_cols), collapse=", "), "\n\n")
# Add batch indicators
ebpp_clean$Batch <- "EBPP"
xena_train$Batch <- "Xena_train"
xena_test$Batch <- "Xena_test"
# Combine for training
train_combined <- rbind(ebpp_clean, xena_train)
# Shuffle training data
train_combined <- train_combined[sample(nrow(train_combined)), ]
cat("=== Training Data Composition ===\n")
cat("Total training samples:", nrow(train_combined), "\n")
cat("  EBPP (log2):", sum(train_combined$Batch == "EBPP"), "\n")
cat("  Xena:", sum(train_combined$Batch == "Xena_train"), "\n\n")
cat("Label distribution in training:\n")
print(table(train_combined$Label))
cat("\nBatch distribution in training:\n")
print(table(train_combined$Batch))
cat("\n")
# Final metadata check
final_metadata <- intersect(colnames(train_combined), c(metadata_cols, "Batch"))
cat("Final metadata columns in training set:\n")
cat("  ", paste(final_metadata, collapse=", "), "\n\n")
# Save training set, test set,
fwrite(train_combined, '../data/formatted_full_L1000/training/train_stratified.csv.gz')
fwrite(xena_test, '../data/formatted_full_L1000/training/test_xena_holdout.csv.gz')
fwrite(ebpp_clean, '../data/formatted_full_L1000/training/EBpp_pancancer_cleaned.csv.gz')
fwrite(xena_clean, '../data/formatted_full_L1000/training/xena_rsem_tpm_cleaned.csv.gz')
# Conservative parameters for better C4/C6
conservative_params <- list(
max_depth = 8,
eta = 0.3,
nrounds = 64,
early_stopping_rounds = 4,
gamma = 0.2,
lambda = 1.8,
alpha = 0.2,
ensemble_size = 11,
sample_prop = 0.8,
feature_prop = 0.8,
subsample = 0.8
)
stratified_pair_list <- readRDS('../models/pair_list_stratified.rds')
this_set <- editPairList(stratified_pair_list, 'IGJ')
library(ImmuneSubtypeClassifier)
this_set <- editPairList(stratified_pair_list, 'IGJ')
# Now use the cleaned pair_list
result <- build_robencla_classifier(
data_path='../data/formatted_full_L1000/training/train_stratified.csv.gz',
test_path='../data/formatted_full_L1000/training/test_xena_holdout.csv.gz',
output_path = '../models/immune_optimized_pairs_64.rds',
pair_list = this_set,
sig_list = NULL,
param_list = conservative_params,
data_mode = c("namedpairs"),
train_fraction = NULL,
seed = 412,
sample_id = "Barcode"  # Specify the sample ID column
)
stratified_pair_list <- readRDS('../models/pair_list_stratified.rds')
this_set <- editPairList(stratified_pair_list, 'IGJ')
this_set <- this_set[1:100]
this_set <- editPairList(stratified_pair_list, 'IGJ')
this_set <- this_set[1:104]
104/2
# Now use the cleaned pair_list
result <- build_robencla_classifier(
data_path='../data/formatted_full_L1000/training/train_stratified.csv.gz',
test_path='../data/formatted_full_L1000/training/test_xena_holdout.csv.gz',
output_path = '../models/immune_optimized_52_pairs.rds',
pair_list = this_set,
sig_list = NULL,
param_list = conservative_params,
data_mode = c("namedpairs"),
train_fraction = NULL,
seed = 412,
sample_id = "Barcode"  # Specify the sample ID column
)
Xs <- readr::read_csv('../data/formatted_full_L1000/training/xena_rsem_tpm_cleaned.csv.gz')
result <- callSubtypes(Xs,
model = NULL,
model_path = '../models/immune_optimized_52_pairs.rds',
geneid = "symbol",
sampleid = 'Barcode',
labelid='Label')
Es <- readr::read_csv('../data/formatted_full_L1000/training/EBpp_pancancer_cleaned.csv.gz')
colnames(Es)[! colnames(Es) %in% colnames(Xs)]
model <- readRDS('../models/immune_optimized_52_pairs.rds')
model$pair_list
stratified_pair_list <- readRDS('../models/pair_list_stratified.rds')
stratified_pair_list
stratified_pair_list[stratified_pair_list == 'STAT1_1']
stratified_pair_list[stratified_pair_list == 'STAT1_1'] <- 'STAT1'
this_set <- editPairList(stratified_pair_list, 'IGJ')
this_set <- this_set[1:104]
# Conservative parameters for better C4/C6
conservative_params <- list(
max_depth = 6,
eta = 0.2,
nrounds = 64,
early_stopping_rounds = 4,
gamma = 0.3,
lambda = 1.9,
alpha = 0.3,
ensemble_size = 11,
sample_prop = 0.8,
feature_prop = 0.8,
subsample = 0.8
)
# Now use the cleaned pair_list
result <- build_robencla_classifier(
data_path='../data/formatted_full_L1000/training/train_stratified.csv.gz',
test_path='../data/formatted_full_L1000/training/test_xena_holdout.csv.gz',
output_path = '../models/immune_optimized_52_pairs.rds',
pair_list = this_set,
sig_list = NULL,
param_list = conservative_params,
data_mode = c("namedpairs"),
train_fraction = NULL,
seed = 412,
sample_id = "Barcode"  # Specify the sample ID column
)
# Conservative parameters for better C4/C6
conservative_params <- list(
max_depth = 8,
eta = 0.2,
nrounds = 64,
early_stopping_rounds = 4,
gamma = 0.3,
lambda = 1.9,
alpha = 0.3,
ensemble_size = 11,
sample_prop = 0.8,
feature_prop = 0.8,
subsample = 0.8
)
stratified_pair_list <- readRDS('../models/pair_list_stratified.rds')
stratified_pair_list[stratified_pair_list == 'STAT1_1'] <- 'STAT1'
this_set <- editPairList(stratified_pair_list, 'IGJ')
this_set <- this_set[1:104]
# Now use the cleaned pair_list
result <- build_robencla_classifier(
data_path='../data/formatted_full_L1000/training/train_stratified.csv.gz',
test_path='../data/formatted_full_L1000/training/test_xena_holdout.csv.gz',
output_path = '../models/immune_optimized_52_pairs.rds',
pair_list = this_set,
sig_list = NULL,
param_list = conservative_params,
data_mode = c("namedpairs"),
train_fraction = NULL,
seed = 412,
sample_id = "Barcode"  # Specify the sample ID column
)
stratified_pair_list <- readRDS('../models/pair_list_stratified.rds')
stratified_pair_list[stratified_pair_list == 'STAT1_1'] <- 'STAT1'
this_set <- editPairList(stratified_pair_list, 'IGJ')
this_set <- this_set
# Now use the cleaned pair_list
result <- build_robencla_classifier(
data_path='../data/formatted_full_L1000/training/train_stratified.csv.gz',
test_path='../data/formatted_full_L1000/training/test_xena_holdout.csv.gz',
output_path = '../models/immune_optimized_52_pairs.rds',
pair_list = this_set,
sig_list = NULL,
param_list = conservative_params,
data_mode = c("namedpairs"),
train_fraction = NULL,
seed = 412,
sample_id = "Barcode"  # Specify the sample ID column
)
# Now use the cleaned pair_list
result <- build_robencla_classifier(
data_path='../data/formatted_full_L1000/training/train_stratified.csv.gz',
test_path='../data/formatted_full_L1000/training/test_xena_holdout.csv.gz',
output_path = '../models/immune_optimized_99_pairs.rds',
pair_list = this_set,
sig_list = NULL,
param_list = conservative_params,
data_mode = c("namedpairs"),
train_fraction = NULL,
seed = 412,
sample_id = "Barcode"  # Specify the sample ID column
)
result <- callSubtypes(Xs,
model = NULL,
model_path = '../models/immune_optimized_99_pairs.rds',
geneid = "symbol",
sampleid = 'Barcode',
labelid='Label')
library(caret)
ImmuneSubtypeClassifier::subtypePerf(result$BestCall, result$Label)
table(result$BestCall, result$Label)
renv::install('.')
library(ImmuneSubtypeClassifier)
Xs <- readr::read_csv('../data/formatted_full_L1000/training/xena_rsem_tpm_cleaned.csv.gz')
#Es <- readr::read_csv('../data/formatted_full_L1000/training/EBpp_pancancer_cleaned.csv.gz')
result <- callSubtypes(Xs,
model = NULL,
model_path = '../models/immune_optimized_99_pairs.rds',
geneid = "symbol",
sampleid = 'Barcode',
labelid='Label')
ImmuneSubtypeClassifier::subtypePerf(result$BestCall, result$Label)
robencla::Metrics()
robencla::Metrics
table(result$BestCall, result$Label)
renv::install('.')
library(ImmuneSubtypeClassifier)
Xs <- readr::read_csv('../data/formatted_full_L1000/training/xena_rsem_tpm_cleaned.csv.gz')
#Es <- readr::read_csv('../data/formatted_full_L1000/training/EBpp_pancancer_cleaned.csv.gz')
model,result <- callSubtypes(Xs,
#Es <- readr::read_csv('../data/formatted_full_L1000/training/EBpp_pancancer_cleaned.csv.gz')
(model,result) <- callSubtypes(Xs,
#Es <- readr::read_csv('../data/formatted_full_L1000/training/EBpp_pancancer_cleaned.csv.gz')
res0 <- callSubtypes(Xs,
model = NULL,
model_path = '../models/immune_optimized_99_pairs.rds',
geneid = "symbol",
sampleid = 'Barcode',
labelid='Label')
model <- res0$Model
pred  <- res0$Pred
model$classification_metrics()
model$classification_metrics()
Xs$Label
Xs$Label <- as.character(Xs$Label)
Xs$Label
model$predict(
data_frame = Xs,
label_name = "Label",
sample_id = "Barcode"
)
model$classification_metrics()
model$importance(
)
model$importance()
model$classification_metrics()
model$classification_metrics(labels = pred$Label, calls = pred$BestCall)
model$importance()
renv::install('../robencla/')
library(ImmuneSubtypeClassifier)
# Conservative parameters for better C4/C6
conservative_params <- list(
max_depth = 8,
eta = 0.2,
nrounds = 64,
early_stopping_rounds = 4,
gamma = 0.3,
lambda = 1.9,
alpha = 0.3,
ensemble_size = 11,
sample_prop = 0.8,
feature_prop = 0.8,
subsample = 0.8
)
stratified_pair_list <- readRDS('../models/pair_list_stratified.rds')
stratified_pair_list[stratified_pair_list == 'STAT1_1'] <- 'STAT1'
this_set <- editPairList(stratified_pair_list, 'IGJ')
this_set <- this_set
# Now use the cleaned pair_list
result <- build_robencla_classifier(
data_path='../data/formatted_full_L1000/training/train_stratified.csv.gz',
test_path='../data/formatted_full_L1000/training/test_xena_holdout.csv.gz',
output_path = '../models/immune_optimized_99_pairs.rds',
pair_list = this_set,
sig_list = NULL,
param_list = conservative_params,
data_mode = c("namedpairs"),
train_fraction = NULL,
seed = 412,
sample_id = "Barcode"  # Specify the sample ID column
)
library(ImmuneSubtypeClassifier)
Xs <- readr::read_csv('../data/formatted_full_L1000/training/xena_rsem_tpm_cleaned.csv.gz')
#Es <- readr::read_csv('../data/formatted_full_L1000/training/EBpp_pancancer_cleaned.csv.gz')
Xs$Label <- as.character(Xs$Label)
res0 <- callSubtypes(Xs,
model = NULL,
model_path = '../models/immune_optimized_99_pairs.rds',
geneid = "symbol",
sampleid = 'Barcode',
labelid='Label')
model <- res0$Model
pred  <- res0$Pred
table(result$BestCall, result$Label)
model$classification_metrics(labels = pred$Label, calls = pred$BestCall)
View(result)
View(pred)
table(pred$BestCall, pred$Label)
devtools::document()
renv::install('.')
typeof("asdf")
devtools::document()
renv::install('.')
library(ImmuneSubtypeClassifier)
Xs <- readr::read_csv('../data/formatted_full_L1000/training/xena_rsem_tpm_cleaned.csv.gz')
#Es <- readr::read_csv('../data/formatted_full_L1000/training/EBpp_pancancer_cleaned.csv.gz')
Xs$Label <- as.character(Xs$Label)
res0 <- callSubtypes(Xs,
model = NULL,
model_path = '../models/immune_optimized_99_pairs.rds',
geneid = "symbol",
sampleid = 'Barcode',
labelid='Label')
renv::install('.')
library(ImmuneSubtypeClassifier)
Xs <- readr::read_csv('../data/formatted_full_L1000/training/xena_rsem_tpm_cleaned.csv.gz')
#Es <- readr::read_csv('../data/formatted_full_L1000/training/EBpp_pancancer_cleaned.csv.gz')
Xs$Label <- as.character(Xs$Label)
res0 <- callSubtypes(Xs,
model = NULL,
model_path = '../models/immune_optimized_99_pairs.rds',
geneid = "symbol",
sampleid = 'Barcode',
labelid='Label')
model <- res0$Model
pred  <- res0$Pred
table(pred$BestCall, pred$Label)
model$classification_metrics(labels = pred$Label, calls = pred$BestCall)
modelGenes('../models/immune_optimized_99_pairs.rds')
modelGenes(model_path='../models/immune_optimized_99_pairs.rds')
renv::install('.')
library(ImmuneSubtypeClassifier)
Xs <- readr::read_csv('../data/formatted_full_L1000/training/xena_rsem_tpm_cleaned.csv.gz')
#Es <- readr::read_csv('../data/formatted_full_L1000/training/EBpp_pancancer_cleaned.csv.gz')
Xs$Label <- as.character(Xs$Label)
res0 <- callSubtypes(Xs,
model = NULL,
model_path = '../models/immune_optimized_99_pairs.rds',
geneid = "symbol",
sampleid = 'Barcode',
labelid='Label')
model <- res0$Model
pred  <- res0$Pred
table(pred$BestCall, pred$Label)
model$classification_metrics(labels = pred$Label, calls = pred$BestCall)
modelGenes(model_path='../models/immune_optimized_99_pairs.rds')
renv::install('.')
library(ImmuneSubtypeClassifier)
Xs <- readr::read_csv('../data/formatted_full_L1000/training/xena_rsem_tpm_cleaned.csv.gz')
#Es <- readr::read_csv('../data/formatted_full_L1000/training/EBpp_pancancer_cleaned.csv.gz')
Xs$Label <- as.character(Xs$Label)
res0 <- callSubtypes(Xs,
model = NULL,
model_path = '../models/immune_optimized_99_pairs.rds',
geneid = "symbol",
sampleid = 'Barcode',
labelid='Label')
model <- res0$Model
pred  <- res0$Pred
table(pred$BestCall, pred$Label)
model$classification_metrics(labels = pred$Label, calls = pred$BestCall)
modelGenes(model_path='../models/immune_optimized_99_pairs.rds')
model_genes <- modelGenes(model_path='../models/immune_optimized_99_pairs.rds')
model_genes$gene_map
dim(model_genes$gene_map)
length(model_genes$model_genes == nrow(model_genes$gene_map)
)
length(model_genes$model_genes) == nrow(model_genes$gene_map)
