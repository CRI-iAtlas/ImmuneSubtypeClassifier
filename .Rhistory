#' results <- callSubtypes(expr_matrix, model = my_model, geneid = "symbol")
#'
#' # View results
#' table(results$BestCall)
#' }
#'
#' @export
callSubtypes <- function(X,
model = NULL,
model_path = NULL,
geneid = "symbol") {
if (is.null(model)) {
if (!is.null(model_path)) {
env <- new.env()
load(model_path, envir = env)
model <- env$emod
} else {
data("robencla_model", envir = environment())
model <- emod
}
}
if (geneid != "symbols") {
res0 <- geneMatch(X, geneid)
X <- res0$Subset
reportError(res0$matchError)
}
print(paste0("data subset: ", as.character(dim(X))))
model$predict(
data_frame = X,
label_name = NULL,
sample_id = "SampleID"
)
results <- model$results(include_label = FALSE)
output <- data.frame(
SampleIDs = results$SampleID,
BestCall = as.integer(gsub("C", "", results$BestCall)),
stringsAsFactors = FALSE
)
score_cols <- grep("^C[1-6]$", colnames(results), value = TRUE)
if (length(score_cols) > 0) {
scores <- results[, score_cols, drop = FALSE]
colnames(scores) <- gsub("C", "", colnames(scores))
scores <- scores[, as.character(1:6)]
output <- cbind(output, scores)
}
return(output)
}
callSubtypes(testdat, model_path='model/robencla_trained_model.rda')
source("~/Work/imm_subtype_pred/ImmuneSubtypeClassifier/R/callSubtypes.R", echo = TRUE)
callSubtypes(testdat, model_path='model/robencla_trained_model.rda')
testdat[1:5,1:5]
testdat$SampleID
callSubtypes(testdat, model_path='model/robencla_trained_model.rda', geneid = 'symbol')
callSubtypes <- function(X,
model = NULL,
model_path = NULL,
geneid = "symbol",
sampleid = 'SampleBarcode') {
if (is.null(model)) {
if (!is.null(model_path)) {
env <- new.env()
load(model_path, envir = env)
model <- env$emod
} else {
data("robencla_model", envir = environment())
model <- emod
}
}
if (geneid != "symbols") {
res0 <- geneMatch(X, geneid)
X <- res0$Subset
reportError(res0$matchError)
}
print(paste0("data subset: ", as.character(dim(X))))
model$predict(
data_frame = X,
label_name = NULL,
sample_id = sampleid
)
results <- model$results(include_label = FALSE)
output <- data.frame(
SampleIDs = results$SampleID,
BestCall = as.integer(gsub("C", "", results$BestCall)),
stringsAsFactors = FALSE
)
score_cols <- grep("^C[1-6]$", colnames(results), value = TRUE)
if (length(score_cols) > 0) {
scores <- results[, score_cols, drop = FALSE]
colnames(scores) <- gsub("C", "", colnames(scores))
scores <- scores[, as.character(1:6)]
output <- cbind(output, scores)
}
return(output)
}
callSubtypes(testdat, model_path='model/robencla_trained_model.rda', geneid = 'symbol')
modelgenes <- unique(as.vector(unlist(getDefaultPairList())))
length(modelgenes)  # Should be ~50-60 unique genes
# What's in your test data?
colnames(testdat)[1:10]
# How many match?
sum(modelgenes %in% colnames(testdat))
# Which are missing?
modelgenes[!modelgenes %in% colnames(testdat)]
callSubtypes <- function(X,
model = NULL,
model_path = NULL,
geneid = "symbol",
sampleid = 'SampleBarcode') {
if (is.null(model)) {
if (!is.null(model_path)) {
env <- new.env()
load(model_path, envir = env)
model <- env$emod
} else {
data("robencla_model", envir = environment())
model <- emod
}
}
if (geneid != "symbols") {
res0 <- geneMatch(X, geneid)
X <- res0$Subset
reportError(res0$matchError)
}
print(paste0("data subset: ", as.character(dim(X))))
model$predict(
data_frame = X,
label_name = NULL,
sample_id = sampleid
)
results <- model$results(include_label = FALSE)
output <- data.frame(
SampleIDs = results$SampleID,
BestCall = as.integer(gsub("C", "", results$BestCall)),
stringsAsFactors = FALSE
)
score_cols <- grep("^C[1-6]$", colnames(results), value = TRUE)
if (length(score_cols) > 0) {
scores <- results[, score_cols, drop = FALSE]
colnames(scores) <- gsub("C", "", colnames(scores))
scores <- scores[, as.character(1:6)]
output <- cbind(output, scores)
}
return(output)
}
res0 <- geneMatch(testdat, geneid = "symbol")
X <- res0$Subset
dim(X)  # Should be 20 samples Ã— 36 genes
class(X)
# Does it have a SampleID column?
"SampleID" %in% colnames(X)
source("~/Work/imm_subtype_pred/ImmuneSubtypeClassifier/R/callSubtypes.R", echo = TRUE)
callSubtypes(testdat, model_path='model/robencla_trained_model.rda', geneid = 'symbol')
# What's testdat look like?
dim(testdat)
class(testdat)
# After geneMatch
res0 <- geneMatch(testdat, geneid = "symbol")
dim(res0$Subset)
class(res0$Subset)
# Is there a SampleBarcode column?
"SampleBarcode" %in% colnames(testdat)
"SampleBarcode" %in% colnames(res0$Subset)
source("~/Work/imm_subtype_pred/ImmuneSubtypeClassifier/R/callSubtypes.R", echo = TRUE)
source("~/Work/imm_subtype_pred/ImmuneSubtypeClassifier/R/callSubtypes.R", echo = TRUE)
callSubtypes(testdat, model_path='model/robencla_trained_model.rda', geneid = 'symbol')
source("~/Work/imm_subtype_pred/ImmuneSubtypeClassifier/R/callSubtypes.R", echo = TRUE)
res0 <- geneMatch(testdat)
res0$matchError
X <- res0$Subset
dim(X)
load('model/robencla_trained_model.rda')
model <- emod
model$predict(
data_frame = X,
label_name = NULL,
sample_id = sampleid
)
sampleid <- 'SampleBarcode'
model$predict(
data_frame = X,
label_name = NULL,
sample_id = sampleid
)
res0 <- geneMatch(testdat)
res0 <- geneMatch(testdat, geneid = 'symbols')
res0 <- geneMatch(testdat, geneid = 'symbol')
X <- res0$Subset
dim(X)
res0 <- geneMatch(testdat, geneid = 'symbol',sampleid = 'SampleBarcode')
colnames(data)
sampleid <- 'Barcode'
res0 <- geneMatch(testdat, geneid = 'symbol',sampleid = 'Barcode')
X <- res0$Subset
X
model$predict(
data_frame = X,
label_name = NULL,
sample_id = sampleid
)
sampleid
X$Barcode
model$predict(
data_frame = X,
label_name = NULL,
sample_id = sampleid
)
model$predict(
data_frame = data,
label_name = 'Label',
sample_id = sampleid
)
model$predict(
data_frame = data,
label_name = 'Label',
sample_id = 'Barcode'
)
model$label_name
model$sample_id
> model$label_name
X$Label <- "Unknown"
model$predict(
data_frame = data,
label_name = 'Label',
sample_id = 'Barcode'
)
model$predict(
data_frame = as.data.frame(data),
label_name = 'Label',
sample_id = 'Barcode'
)
source("~/Work/imm_subtype_pred/ImmuneSubtypeClassifier/R/trainRobencla.R", echo = TRUE)
fmod <- build_robencla_classifier(data_path = '../data/EBpp_pancancer.csv.gz', output_path = '../newmodel.rda')
# Load the original training data you used
ebpp <- readr::read_csv('../data/EBpp_pancancer.csv.gz')
ebpp$Label <- paste0('C', ebpp$Label)  # if needed
# Try just a few rows
test_subset <- as.data.frame(ebpp[1:10, ])
model$predict(
data_frame = test_subset,
label_name = 'Label',
sample_id = 'Barcode'
)
source("~/Work/imm_subtype_pred/ImmuneSubtypeClassifier/R/trainRobencla.R", echo = TRUE)
fmod <- build_robencla_classifier(data_path = '../data/EBpp_pancancer.csv.gz', output_path = '../newmodel.rda')
source("~/Work/imm_subtype_pred/ImmuneSubtypeClassifier/R/trainRobencla.R", echo = TRUE)
fmod <- build_robencla_classifier(data_path = '../data/EBpp_pancancer.csv.gz', output_path = '../newmodel.rda')
source("~/Work/imm_subtype_pred/ImmuneSubtypeClassifier/R/trainRobencla.R", echo = TRUE)
packageVersion("robencla")
library(robencla)
pair_list <- list(
C1=c("B2M","COL3A1","B2M","COL1A2","COL1A2","HLA-B","COL3A1","HLA-B","APOE","COL6A3","APOE","SDC1","APOE","COL6A1","APOE","MMP14","APOE","MMP2","COL1A2","SPARC"),
C2=c('IFI27','RHOB','IFI6','RHOB','IFI27','LRP1','IFI27','NPC2','IFI6','NPC2','IFI27','TAGLN','RHOB','STAT1','IFI6','LRP1','IFI27','IGFBP3','IFI27','IGFBP4'),
C3=c('COL3A1','SPARC','IGFBP4','JUP','CD59','JUP','NPC2','SLC25A5','IFI27','NPC2','IGFBP4','PFN1','HNRNPA2B1','IGFBP4','CCT5','NPC2','IFI27','MET','IGFBP4','TPI1'),
C4=c('APOE','COL3A1','APOE','COL1A2','COL3A1','SPARC','APOC1','DSP','COL1A2','SPARC','APOC1','JUP','APOC1','COL6A3','APOC1','LYZ','APOC1','SDC1','DSP','RHOB'),
C5=c('APOE','FN1','FN1','SPARC','APOE','COL3A1','APOE','COL1A2','B2M','SPARC','APOE','B2M','FN1','SLC1A3','COL3A1','SLC1A3','APOE','HLA-B','COL1A2','SLC1A3'),
C6=c('B2M','COL3A1','B2M','COL1A2','COL6A3','ENO1','BSG','COL6A3','COL6A3','HNRNPA2B1','COL6A3','MYL6','BSG','COL6A1','COL6A3','DSP','BSG','MMP2','JUP','MMP2')
)
ebpp <- readr::read_csv('../data/EBpp_pancancer.csv.gz')
ebpp$Label <- sapply(ebpp$Label, function(a) paste0('C',a))
mod <- Robencla$new("test")
mod$train(
data_frame = ebpp,
label_name = 'Label',
sample_id = 'Barcode',
data_mode = c('namedpairs'),
signatures = NULL,
pair_list = pair_list,
params = list(
max_depth=12, eta=0.3, nrounds=64, early_stopping_rounds=2,
nthreads=4, gamma=0.2, lambda=1.2, alpha=0.2, size=11,
sample_prop=0.8, feature_prop=0.8, subsample=0.8,
combine_function='median', verbose=0
)
)
mod$predict(
data_frame = ebpp,
label_name = 'Label',
sample_id = 'Barcode'
)
mod$results()
mod$trim()
# Predict again after trim
mod$predict(
data_frame = ebpp,
label_name = 'Label',
sample_id = 'Barcode'
)
mod$results()
source("~/Work/imm_subtype_pred/ImmuneSubtypeClassifier/R/trainRobencla.R", echo = TRUE)
# Fresh R session
library(ImmuneSubtypeClassifier)
# Fresh R session
library(ImmuneSubtypeClassifier)
ebpp <- readr::read_csv('../data/EBpp_pancancer.csv.gz')
ebpp$Label <- paste0('C', ebpp$Label)
source("~/Work/imm_subtype_pred/ImmuneSubtypeClassifier/R/callSubtypes.R", echo = TRUE)
callSubtypes(ebpp, model_path = 'model/robencla_trained_model.rda', geneid = 'symbol')
library(data.table)
callSubtypes(ebpp, model_path = 'model/robencla_trained_model.rda', geneid = 'symbol')
source("~/Work/imm_subtype_pred/ImmuneSubtypeClassifier/R/trainRobencla.R", echo = TRUE)
model <- trainRobencla(
data = ebpp,
label_name = 'Label',
sample_id = 'Barcode',
pair_list = getDefaultPairList()
)
mod$train(
data_frame = ebpp,
label_name = 'Label',
sample_id = 'Barcode',
data_mode = c('namedpairs'),
signatures = NULL,
pair_list = pair_list,
params = list(
max_depth=12, eta=0.3, nrounds=64, early_stopping_rounds=2,
nthreads=4, gamma=0.2, lambda=1.2, alpha=0.2, size=11,
sample_prop=0.8, feature_prop=0.8, subsample=0.8,
combine_function='median', verbose=0
)
)
pair_list <- list(
C1=c("B2M","COL3A1","B2M","COL1A2","COL1A2","HLA-B","COL3A1","HLA-B","APOE","COL6A3","APOE","SDC1","APOE","COL6A1","APOE","MMP14","APOE","MMP2","COL1A2","SPARC"),
C2=c('IFI27','RHOB','IFI6','RHOB','IFI27','LRP1','IFI27','NPC2','IFI6','NPC2','IFI27','TAGLN','RHOB','STAT1','IFI6','LRP1','IFI27','IGFBP3','IFI27','IGFBP4'),
C3=c('COL3A1','SPARC','IGFBP4','JUP','CD59','JUP','NPC2','SLC25A5','IFI27','NPC2','IGFBP4','PFN1','HNRNPA2B1','IGFBP4','CCT5','NPC2','IFI27','MET','IGFBP4','TPI1'),
C4=c('APOE','COL3A1','APOE','COL1A2','COL3A1','SPARC','APOC1','DSP','COL1A2','SPARC','APOC1','JUP','APOC1','COL6A3','APOC1','LYZ','APOC1','SDC1','DSP','RHOB'),
C5=c('APOE','FN1','FN1','SPARC','APOE','COL3A1','APOE','COL1A2','B2M','SPARC','APOE','B2M','FN1','SLC1A3','COL3A1','SLC1A3','APOE','HLA-B','COL1A2','SLC1A3'),
C6=c('B2M','COL3A1','B2M','COL1A2','COL6A3','ENO1','BSG','COL6A3','COL6A3','HNRNPA2B1','COL6A3','MYL6','BSG','COL6A1','COL6A3','DSP','BSG','MMP2','JUP','MMP2')
)
ebpp <- readr::read_csv('../data/EBpp_pancancer.csv.gz')
ebpp$Label <- sapply(ebpp$Label, function(a) paste0('C',a))
mod <- Robencla$new("test")
library(robencla)
model <- trainRobencla(
data = ebpp,
label_name = 'Label',
sample_id = 'Barcode',
pair_list = getDefaultPairList()
)
callSubtypes(ebpp, model = model, geneid = 'symbol')
source("~/Work/imm_subtype_pred/ImmuneSubtypeClassifier/R/callSubtypes.R", echo = TRUE)
callSubtypes(ebpp, model = model, geneid = 'symbol')
callSubtypes(ebpp[1:10,], model = model, geneid = 'symbol')
source("~/Work/imm_subtype_pred/ImmuneSubtypeClassifier/R/callSubtypes.R", echo = TRUE)
callSubtypes(ebpp[1:10,], model = model, geneid = 'symbol')
save(model, file='model/robencla_trained_model.rda')
callSubtypes(ebpp[1:10,], model_path = 'model/robencla_trained_model.rda', geneid = 'symbol')
saveRDS(model, file = 'model/robencla_trained_model.rds')
callSubtypes(ebpp[1:10,], model_path = 'model/robencla_trained_model.rda', geneid = 'symbol')
model_loaded <- readRDS('model/robencla_trained_model.rds')
callSubtypes(ebpp[1:10,], model = model, geneid = 'symbol')
callSubtypes(ebpp[1:10,], model = model_loaded, geneid = 'symbol')
source("~/Work/imm_subtype_pred/ImmuneSubtypeClassifier/R/callSubtypes.R", echo = TRUE)
callSubtypes(ebpp[1:10,], model = model_loaded, geneid = 'symbol')
callSubtypes(ebpp[1:10,], model = model_loaded, geneid = 'symbol', labelid = 'Label')
callSubtypes(ebpp[1:10,], model = model_loaded, geneid = 'symbol', labelid = NULL)
source("~/Work/imm_subtype_pred/ImmuneSubtypeClassifier/R/callSubtypes.R", echo = TRUE)
callSubtypes(ebpp[1:10,], model = model_loaded, geneid = 'symbol', labelid = NULL)
callSubtypes(ebpp[1:10,], model = model_loaded, geneid = 'symbol')
callSubtypes(ebpp[1:10,], model_path = 'model/robencla_trained_model.rda', geneid = 'symbol')
#'
#' # Using a custom model
#' my_model <- readRDS("path/to/model.rds")
#' results <- callSubtypes(expr_matrix, model = my_model, geneid = "symbol")
#'
#' # View results
#' table(results$BestCall)
#' }
#'
#' @export
callSubtypes <- function(X,
model = NULL,
model_path = NULL,
geneid = "symbol",
sampleid = 'Barcode') {
if (is.null(model)) {
if (!is.null(model_path)) {
env <- new.env()
readRDS(model_path)
model <- env$emod
} else {
data("robencla_model", envir = environment())
model <- emod
}
}
res0 <- geneMatch(X, geneid, sampleid = sampleid)
X <- res0$Subset
if (res0$matchError > 0.05) {
reportError(res0$matchError)
}
model$predict(
data_frame = X,
label_name = NULL,
sample_id = sampleid
)
results <- model$results()
output <- data.frame(
SampleIDs = results$SampleID,
BestCall = as.integer(gsub("C", "", results$BestCall)),
stringsAsFactors = FALSE
)
score_cols <- grep("^C[1-6]$", colnames(results), value = TRUE)
if (length(score_cols) > 0) {
scores <- results[, score_cols, drop = FALSE]
colnames(scores) <- gsub("C", "", colnames(scores))
scores <- scores[, as.character(1:6)]
output <- cbind(output, scores)
}
return(output)
}
callSubtypes(ebpp[1:10,], model_path = 'model/robencla_trained_model.rda', geneid = 'symbol')
#'
#' # Using a custom model
#' my_model <- readRDS("path/to/model.rds")
#' results <- callSubtypes(expr_matrix, model = my_model, geneid = "symbol")
#'
#' # View results
#' table(results$BestCall)
#' }
#'
#' @export
callSubtypes <- function(X,
model = NULL,
model_path = NULL,
geneid = "symbol",
sampleid = 'Barcode') {
if (is.null(model)) {
if (!is.null(model_path)) {
model <- readRDS(model_path)
} else {
data("robencla_model", envir = environment())
model <- emod
}
}
res0 <- geneMatch(X, geneid, sampleid = sampleid)
X <- res0$Subset
if (res0$matchError > 0.05) {
reportError(res0$matchError)
}
model$predict(
data_frame = X,
label_name = NULL,
sample_id = sampleid
)
results <- model$results()
output <- data.frame(
SampleIDs = results$SampleID,
BestCall = as.integer(gsub("C", "", results$BestCall)),
stringsAsFactors = FALSE
)
score_cols <- grep("^C[1-6]$", colnames(results), value = TRUE)
if (length(score_cols) > 0) {
scores <- results[, score_cols, drop = FALSE]
colnames(scores) <- gsub("C", "", colnames(scores))
scores <- scores[, as.character(1:6)]
output <- cbind(output, scores)
}
return(output)
}
callSubtypes(ebpp[1:10,], model_path = 'model/robencla_trained_model.rda', geneid = 'symbol')
#'
#' # Using a custom model
#' my_model <- readRDS("path/to/model.rds")
#' results <- callSubtypes(expr_matrix, model = my_model, geneid = "symbol")
#'
#' # View results
#' table(results$BestCall)
#' }
#'
#' @export
callSubtypes <- function(X,
model = NULL,
model_path = NULL,
geneid = "symbol",
sampleid = 'Barcode') {
if (is.null(model)) {
if (!is.null(model_path)) {
model <- readRDS(model_path)
} else {
data("robencla_model", envir = environment())
model <- emod
}
}
res0 <- geneMatch(X, geneid, sampleid = sampleid)
X <- res0$Subset
if (res0$matchError > 0.05) {
reportError(res0$matchError)
}
model$predict(
data_frame = X,
label_name = NULL,
sample_id = sampleid
)
results <- model$results()
output <- data.frame(
SampleIDs = results$SampleID,
BestCall = as.integer(gsub("C", "", results$BestCall)),
stringsAsFactors = FALSE
)
score_cols <- grep("^C[1-6]$", colnames(results), value = TRUE)
if (length(score_cols) > 0) {
scores <- results[, score_cols, drop = FALSE]
colnames(scores) <- gsub("C", "", colnames(scores))
scores <- scores[, as.character(1:6)]
output <- cbind(output, scores)
}
return(output)
}
callSubtypes(ebpp[1:10,], model_path = 'model/robencla_trained_model.rda', geneid = 'symbol')
model_loaded <- readRDS('model/robencla_trained_model.rds')
callSubtypes(ebpp[1:10,], model = model_loaded, geneid = 'symbol')
source("~/Work/imm_subtype_pred/ImmuneSubtypeClassifier/R/callSubtypes.R", echo = TRUE)
callSubtypes(ebpp[1:10,], geneid = 'symbol')
